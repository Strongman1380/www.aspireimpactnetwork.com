<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Support Ticket - Aspire Impact Network</title>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary-color: #2c5f41;
            --accent-color: #4a9960;
            --accent-light: #6bb77b;
            --text-light: #2c3e50;
            --text-gray: #495057;
            --border-color: #e9ecef;
            --bg-light: #f8f9fa;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .support-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            padding: 50px;
            max-width: 800px;
            width: 100%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .header p {
            font-size: 1.2rem;
            color: var(--text-gray);
            line-height: 1.6;
        }
        
        .form-section {
            margin-bottom: 40px;
        }
        
        .form-section h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-light);
        }
        
        .required {
            color: var(--danger-color);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(74, 153, 96, 0.2);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .priority-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .priority-option {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .priority-option:hover {
            border-color: var(--accent-color);
        }
        
        .priority-option.selected {
            border-color: var(--accent-color);
            background: rgba(74, 153, 96, 0.1);
            color: var(--accent-color);
        }
        
        .priority-low { border-left: 4px solid #27ae60; }
        .priority-medium { border-left: 4px solid #f39c12; }
        .priority-high { border-left: 4px solid #e67e22; }
        .priority-urgent { border-left: 4px solid #e74c3c; }
        
        .attachment-area {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .attachment-area:hover {
            border-color: var(--accent-color);
            background: rgba(74, 153, 96, 0.05);
        }
        
        .attachment-area.dragover {
            border-color: var(--accent-color);
            background: rgba(74, 153, 96, 0.1);
        }
        
        .attachment-icon {
            font-size: 3rem;
            color: var(--text-gray);
            margin-bottom: 15px;
        }
        
        .existing-tickets {
            background: var(--bg-light);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .existing-tickets h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .ticket-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent-color);
        }
        
        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .ticket-subject {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .ticket-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-open { background: #d4edda; color: #155724; }
        .status-in-progress { background: #fff3cd; color: #856404; }
        .status-resolved { background: #cce7ff; color: #0056b3; }
        
        .ticket-date {
            font-size: 0.9rem;
            color: var(--text-gray);
        }
        
        .submit-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(74, 153, 96, 0.3);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .back-links {
            text-align: center;
            margin-top: 30px;
        }
        
        .back-link {
            display: inline-block;
            padding: 12px 25px;
            margin: 0 10px;
            color: var(--accent-color);
            text-decoration: none;
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .back-link:hover {
            background: var(--accent-color);
            color: white;
            text-decoration: none;
        }
        
        .success-message,
        .error-message {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-gray);
        }
        
        @media (max-width: 768px) {
            .support-container {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .priority-selector {
                grid-template-columns: 1fr 1fr;
            }
            
            .back-links {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="support-container">
        <div class="header">
            <h1>🎫 Submit Support Ticket</h1>
            <p>Need help? We're here to assist you. Submit a support ticket and our team will get back to you as soon as possible.</p>
        </div>

        <!-- Existing Tickets -->
        <div class="existing-tickets" id="existing-tickets" style="display: none;">
            <h3>Your Recent Tickets</h3>
            <div id="tickets-list">
                <!-- Tickets will be loaded here -->
            </div>
        </div>

        <!-- Support Form -->
        <form id="support-form">
            <div class="form-section">
                <h2>Contact Information</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customer-name">Full Name <span class="required">*</span></label>
                        <input type="text" id="customer-name" required>
                    </div>
                    <div class="form-group">
                        <label for="customer-email">Email Address <span class="required">*</span></label>
                        <input type="email" id="customer-email" required>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2>Ticket Details</h2>
                <div class="form-group">
                    <label for="ticket-subject">Subject <span class="required">*</span></label>
                    <input type="text" id="ticket-subject" placeholder="Brief description of your issue..." required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="ticket-category">Category</label>
                        <select id="ticket-category">
                            <option value="general">General Support</option>
                            <option value="billing">Billing & Payments</option>
                            <option value="technical">Technical Issues</option>
                            <option value="account">Account Management</option>
                            <option value="feature_request">Feature Request</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Priority Level</label>
                        <div class="priority-selector">
                            <div class="priority-option priority-low selected" data-priority="low">
                                <div>Low</div>
                                <small>General question</small>
                            </div>
                            <div class="priority-option priority-medium" data-priority="medium">
                                <div>Medium</div>
                                <small>Minor issue</small>
                            </div>
                            <div class="priority-option priority-high" data-priority="high">
                                <div>High</div>
                                <small>Major problem</small>
                            </div>
                            <div class="priority-option priority-urgent" data-priority="urgent">
                                <div>Urgent</div>
                                <small>Critical issue</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="ticket-description">Description <span class="required">*</span></label>
                    <textarea id="ticket-description" placeholder="Please provide detailed information about your issue, including steps to reproduce if applicable..." required></textarea>
                </div>
            </div>

            <div class="form-section">
                <h2>Additional Information</h2>
                <div class="form-group">
                    <label>Attach Files (Optional)</label>
                    <div class="attachment-area" id="attachment-area">
                        <div class="attachment-icon">📎</div>
                        <div>
                            <strong>Drop files here or click to upload</strong><br>
                            <small>Screenshots, error logs, or other relevant files (Max 10MB)</small>
                        </div>
                        <input type="file" id="file-input" multiple style="display: none;" accept="image/*,text/*,.pdf,.doc,.docx">
                    </div>
                    <div id="file-list"></div>
                </div>
            </div>

            <div id="message-area"></div>

            <button type="submit" class="submit-btn" id="submit-btn">
                Submit Support Ticket
            </button>
        </form>

        <div class="back-links">
            <a href="member-dashboard.html" class="back-link">← Back to Dashboard</a>
            <a href="index.html" class="back-link">🏠 Home</a>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://vpxejnebrnwjlnokfkgu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZweGVqbmVicm53amxub2tma2d1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MTkwODMsImV4cCI6MjA2NjE5NTA4M30.wVHoKozEJbkEzlJ0WASQRuSEar2y1qZZQyTun0Ef-gQ';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let selectedPriority = 'low';
        let currentCustomer = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCustomerData();
            setupEventListeners();
        });

        async function loadCustomerData() {
            try {
                // Get the most recent customer (in real app, this would be authenticated user)
                const { data: customers, error } = await supabase
                    .from('customers')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (customers && customers.length > 0) {
                    currentCustomer = customers[0];
                    document.getElementById('customer-name').value = currentCustomer.full_name || '';
                    document.getElementById('customer-email').value = currentCustomer.email || '';
                    
                    // Load existing tickets for this customer
                    await loadExistingTickets(currentCustomer.id);
                } else {
                    // Demo mode
                    document.getElementById('customer-name').value = 'Demo User';
                    document.getElementById('customer-email').value = 'demo@example.com';
                }
            } catch (error) {
                console.error('Error loading customer data:', error);
            }
        }

        async function loadExistingTickets(customerId) {
            try {
                const { data: tickets, error } = await supabase
                    .from('support_tickets')
                    .select('*')
                    .eq('customer_id', customerId)
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                if (tickets && tickets.length > 0) {
                    document.getElementById('existing-tickets').style.display = 'block';
                    const ticketsList = document.getElementById('tickets-list');
                    
                    ticketsList.innerHTML = tickets.map(ticket => `
                        <div class="ticket-item">
                            <div class="ticket-header">
                                <div class="ticket-subject">${ticket.subject}</div>
                                <div class="ticket-status status-${ticket.status.replace('_', '-')}">${ticket.status.replace('_', ' ')}</div>
                            </div>
                            <div class="ticket-date">Created: ${new Date(ticket.created_at).toLocaleDateString()}</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading existing tickets:', error);
            }
        }

        function setupEventListeners() {
            // Priority selection
            document.querySelectorAll('.priority-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.priority-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedPriority = option.dataset.priority;
                });
            });

            // File upload
            const attachmentArea = document.getElementById('attachment-area');
            const fileInput = document.getElementById('file-input');

            attachmentArea.addEventListener('click', () => fileInput.click());

            attachmentArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                attachmentArea.classList.add('dragover');
            });

            attachmentArea.addEventListener('dragleave', () => {
                attachmentArea.classList.remove('dragover');
            });

            attachmentArea.addEventListener('drop', (e) => {
                e.preventDefault();
                attachmentArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // Form submission
            document.getElementById('support-form').addEventListener('submit', handleFormSubmit);
        }

        function handleFiles(files) {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';

            Array.from(files).forEach((file, index) => {
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    return;
                }

                const fileItem = document.createElement('div');
                fileItem.style.cssText = 'padding: 10px; background: #f8f9fa; border-radius: 5px; margin: 5px 0; display: flex; justify-content: space-between; align-items: center;';
                
                fileItem.innerHTML = `
                    <span>📄 ${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                    <button type="button" onclick="this.parentElement.remove()" style="background: #e74c3c; color: white; border: none; border-radius: 3px; padding: 5px 10px; cursor: pointer;">Remove</button>
                `;
                
                fileList.appendChild(fileItem);
            });
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submit-btn');
            const messageArea = document.getElementById('message-area');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            messageArea.innerHTML = '';

            const formData = {
                customer_name: document.getElementById('customer-name').value,
                customer_email: document.getElementById('customer-email').value,
                subject: document.getElementById('ticket-subject').value,
                category: document.getElementById('ticket-category').value,
                priority: selectedPriority,
                description: document.getElementById('ticket-description').value
            };

            try {
                // Create support ticket
                const ticketData = {
                    subject: formData.subject,
                    description: formData.description,
                    priority: formData.priority,
                    category: formData.category,
                    status: 'open'
                };

                if (currentCustomer) {
                    ticketData.customer_id = currentCustomer.id;
                }

                const { data: ticket, error } = await supabase
                    .from('support_tickets')
                    .insert([ticketData])
                    .select()
                    .single();

                if (error) throw error;

                // Log activity
                if (currentCustomer) {
                    await supabase
                        .from('activity_logs')
                        .insert([
                            {
                                customer_id: currentCustomer.id,
                                action_type: 'support_ticket_created',
                                description: `Support ticket created: ${formData.subject}`,
                                metadata: { ticket_id: ticket.id, priority: formData.priority, category: formData.category }
                            }
                        ]);
                }

                // Create email notification
                if (currentCustomer) {
                    await supabase
                        .from('email_notifications')
                        .insert([
                            {
                                customer_id: currentCustomer.id,
                                email_type: 'support_ticket_created',
                                subject: `Support Ticket Created: ${formData.subject}`,
                                content: `Your support ticket has been created and assigned ticket ID: ${ticket.id}. Our team will review your request and respond within 24 hours.`,
                                status: 'pending'
                            }
                        ]);
                }

                messageArea.innerHTML = `
                    <div class="success-message">
                        <h3>🎉 Support Ticket Created Successfully!</h3>
                        <p>Your ticket has been submitted with ID: <strong>${ticket.id}</strong></p>
                        <p>We'll review your request and respond within 24 hours.</p>
                        <p>You can check your email for confirmation and updates.</p>
                    </div>
                `;

                // Reset form
                document.getElementById('support-form').reset();
                document.getElementById('file-list').innerHTML = '';
                selectedPriority = 'low';
                document.querySelectorAll('.priority-option').forEach(opt => opt.classList.remove('selected'));
                document.querySelector('.priority-option[data-priority="low"]').classList.add('selected');

                // Reload existing tickets
                if (currentCustomer) {
                    await loadExistingTickets(currentCustomer.id);
                }

            } catch (error) {
                console.error('Error creating support ticket:', error);
                messageArea.innerHTML = `
                    <div class="error-message">
                        <h3>❌ Error Creating Ticket</h3>
                        <p>There was an error submitting your support ticket. Please try again or contact us directly.</p>
                        <p>Email: <a href="mailto:brandon.hinrichs@aspireimpactnetwork.com">brandon.hinrichs@aspireimpactnetwork.com</a></p>
                        <p>Phone: <a href="tel:+14027592210">(402) 759-2210</a></p>
                    </div>
                `;
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Support Ticket';
        }
    </script>
</body>
</html>